apiVersion: v1
kind: PersistentVolumeClaim
metadata:
    name: mongo-disk
spec:
    accessModes:
    - ReadWriteOnce
    resources:
        requests:
            storage: 3Gi

---

apiVersion: extensions/v1beta1
kind: Deployment
metadata: 
  name: mongo
  labels:
    app: ac-sharescraper
    module: mongo
spec:
  replicas: 1
  template:
    metadata:
      labels:
        app: ac-sharescraper
        module: mongo
    spec:
      containers:
      - name: mongo
        image: mongo
        imagePullPolicy: IfNotPresent
        ports:
        - containerPort: 27017
        volumeMounts:
        - name: mongo-persistent-storage
          mountPath: /data/db
      volumes:
      - name: mongo-persistent-storage
        persistentVolumeClaim:
          claimName: mongo-disk


---

apiVersion: extensions/v1beta1
kind: Deployment
metadata: 
  name: sharescraper-api
  labels:
    app: ac-sharescraper
    module: api
spec:
  replicas: 1
  template:
    metadata:
      labels:
        app: ac-sharescraper
        module: api
    spec:
      containers:
      - name: sharescraper-api
        image: andycowley/sharescraper-api
        imagePullPolicy: IfNotPresent
        ports:
        - containerPort: 5000
        env:
        -   name: MONGO
            value: mongo

---
# Headless Service mongo
apiVersion: v1
kind: Service
metadata:
  name: mongo
spec:
  ports:
  - port: 27017
    name: mongo
  clusterIP: None
  selector:
    app: ac-sharescraper
    module: mongo

---
# Headless Service api
apiVersion: v1
kind: Service
metadata:
  name: api
spec:
  ports:
  - port: 5000
    name: api
  clusterIP: None
  selector:
    app: ac-sharescraper
    module: api

--- 

apiVersion: batch/v1beta1
kind: CronJob
metadata:
  name: scraper-job
spec:
  schedule: "0 10/17 * * *"
  jobTemplate:
    spec:
      template:
        spec:
          containers:
          - name: scraper-job
            image: byrnedo/alpine-curl
            args:
            - http://api:5000/api/refresh-db
          restartPolicy: OnFailure